on:
  release:
    types: [published]
jobs:
  pkg:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
    - run: pip install poetry
    - run: poetry version ${GITHUB_REF:10}
    - run: make
    - uses: actions/upload-artifact@v2
      with:
        name: package
        path: dist/* 
    - run: |
        cat > ~/.pypirc <<- EOM
        [pypi]
        username = __token__
        password = ${{ secrets.PYPI_TOKEN }}

        [testpypi]
        username = __token__
        password = ${{ secrets.TEST_PYPI_TOKEN }}
        EOM
    - run: poetry run twine upload --repository pypi dist/*

  docker:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - run: docker login --username ${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.DOCKER_PASSWORD }}
      - run: docker build . -t "hlambdas/human-lambdas:${GITHUB_REF:10}"
      - run: docker push "hlambdas/human-lambdas:${GITHUB_REF:10}"